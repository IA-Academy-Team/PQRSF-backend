# üìå Proyecto: Sistema PQRS con Chatbot WhatsApp y Gesti√≥n Web

------

## 1Ô∏è‚É£ Resumen ejecutivo

El proyecto consiste en la implementaci√≥n de un **sistema integral de gesti√≥n de PQRS**, donde los clientes interact√∫an inicialmente a trav√©s de un **chatbot en WhatsApp** que recopila informaci√≥n, responde autom√°ticamente mediante una base de conocimiento y, cuando no logra resolver la solicitud, **radica una PQRS** y la asigna al √°rea correspondiente.

Las √°reas internas gestionan las solicitudes desde una **plataforma web**, donde realizan an√°lisis, rean√°lisis (una √∫nica apelaci√≥n permitida) y emiten respuestas. El **administrador** supervisa el proceso, valida apelaciones y decide el cierre de cada solicitud. Una vez cerrada, el sistema env√≠a autom√°ticamente una **encuesta de satisfacci√≥n** al cliente.

El proyecto se ejecuta en **un √∫nico sprint de 8 d√≠as h√°biles**, con un equipo de **4 desarrolladores**, y debe quedar **funcional y desplegado en producci√≥n** para presentaci√≥n ante junta directiva.

------

## 2Ô∏è‚É£ Tecnolog√≠as a usar

- **Frontend:** React
- **Backend:** NodeJS + TypeScript
- **Base de datos:** PostgreSQL (ya existente, sin migraciones)
- **Bots / Automatizaciones:** n8n + WhatsApp Cloud API
- **Comunicaci√≥n en tiempo real:** WebSockets
- **Autenticaci√≥n:** Better Auth

------

## 3Ô∏è‚É£ Requerimientos del software

### 3.1 Requerimientos funcionales

- El sistema debe permitir la **recepci√≥n de solicitudes v√≠a WhatsApp**.
- El chatbot debe:
  - Identificar o registrar clientes.
  - Consultar la base de conocimiento.
  - Radicar autom√°ticamente una PQRS si no puede resolver la solicitud.
- El sistema debe permitir:
  - Asignaci√≥n autom√°tica de √°rea.
  - Gesti√≥n de an√°lisis y rean√°lisis.
  - Una sola apelaci√≥n por solicitud.
- El administrador debe:
  - Validar respuestas.
  - Decidir si una apelaci√≥n procede.
- El sistema debe:
  - Notificar al cliente v√≠a WhatsApp en an√°lisis, rean√°lisis y encuesta.
  - Enviar encuesta al cerrar la solicitud.
- El sistema debe operar con **notificaciones in-app** para usuarios internos.
- El software debe estar **desplegado en servidor productivo**.

------

### 3.2 Requerimientos no funcionales

- Autenticaci√≥n segura mediante Better Auth.
- Comunicaci√≥n en tiempo real mediante WebSockets.
- Arquitectura desacoplada entre bot, backend y frontend.
- Sistema funcional y estable (QA funcional, no automatizado).

------

## 4Ô∏è‚É£ Backlog estructurado

> **Reglas aplicadas**
>
> - 1 sprint
> - Capacidad m√°xima: **16 puntos**
> - 1 punto = **0,5 d√≠as h√°biles**
> - Total backlog = **16 puntos (8 d√≠as)**

------

### üß© √âpica 1: Gesti√≥n de PQRS (Backend Core)

#### üü¢ HU-01

**Como sistema, quiero crear y gestionar PQRS para permitir el seguimiento completo del ciclo de vida de una solicitud.**

**Descripci√≥n:**
 Implementaci√≥n de endpoints para creaci√≥n, consulta y actualizaci√≥n de PQRS con control de estados.

**Criterios de aceptaci√≥n:**

- **Creaci√≥n desde el bot (n8n):** existe un endpoint que el bot puede consumir para **crear una PQRS** y recibe como respuesta al menos: `pqrs_id`, `ticket_number`, `pqrs_status` y `due_date`.
- **Datos m√≠nimos obligatorios:** para crear una PQRS se valida que existan y sean v√°lidos: `client_id`, `type_pqrs_id` y `area_id` (o `area_code`). Si falta alguno, la API responde **400** con mensaje de validaci√≥n.
- **Ticket √∫nico:** el sistema genera un `ticket_number` **√∫nico** (no repetible) y lo persiste; si ocurre colisi√≥n, la operaci√≥n falla con **409** y no deja registros inconsistentes.
- **Estado inicial:** al crear una PQRS, su estado queda en **‚ÄúRadicado‚Äù**.
- **Fecha l√≠mite:** al crear una PQRS se calcula y guarda `due_date` (fecha compromiso) con base en la regla del proceso (**m√°ximo 15 d√≠as h√°biles**; valor configurable si se define en par√°metros/env).
- **Consulta / listado:** existe un endpoint para consultar **detalle** de PQRS y otro para **listar** con filtros m√≠nimos: por `status`, `area`, `ticket_number` y rango de fechas.
- **Reglas de transici√≥n de estados:** la API solo permite transiciones v√°lidas:
  - `Radicado ‚Üí Analisis` (cuando se registra el an√°lisis)
  - `Analisis ‚Üí Cerrado` (cuando el admin cierra)
  - `Analisis ‚Üí Rean√°lisis` (cuando el admin habilita apelaci√≥n)
  - `Rean√°lisis ‚Üí Cerrado` (cierre definitivo)
  - `Radicado ‚Üí Cerrado` **solo** si `is_auto_resolved = true`.
  Cualquier transici√≥n inv√°lida retorna **409** con causa.
- **Trazabilidad:** toda actualizaci√≥n de PQRS actualiza `updated_at` y mantiene `created_at` inmutable.
- **Seguridad y permisos:**
  - Endpoints internos requieren autenticaci√≥n (Better Auth).
  - El endpoint consumido por el bot est√° protegido (API key / service token) y no expone datos internos innecesarios.
**Estimaci√≥n:**

- 6 puntos ‚Üí **3 d√≠as h√°biles**

**Tareas:**

- Crear endpoints PQRS ‚Üí 1,5 d√≠as
- Implementar reglas de estados ‚Üí 1 d√≠a
- Validaciones y pruebas ‚Üí 0,5 d√≠as

------

### üß© √âpica 2: An√°lisis, Rean√°lisis y Decisi√≥n Administrativa

#### üü¢ HU-02

**Como responsable de √°rea, quiero registrar an√°lisis y rean√°lisis para responder adecuadamente a las PQRS asignadas.**

**Descripci√≥n:**
 Permite crear an√°lisis inicial y rean√°lisis, respetando la regla de una sola apelaci√≥n.

**Criterios de aceptaci√≥n:**

- **Permisos por √°rea:** un responsable **solo puede registrar an√°lisis/rean√°lisis** de PQRS asignadas a su `area_id`; si intenta otra, la API responde **403**.
- **Registro de an√°lisis:**
  - Se puede crear **un an√°lisis** por PQRS con campos m√≠nimos `answer` y `action_taken` (no vac√≠os).
  - Al crear el an√°lisis, el estado de la PQRS cambia autom√°ticamente a **‚ÄúAnalisis‚Äù**.
- **Decisi√≥n administrativa:** existe una acci√≥n/endpoint para que el **admin** decida:
  - **Aprobar y cerrar:** cambia estado a **‚ÄúCerrado‚Äù**.
  - **Habilitar apelaci√≥n:** cambia estado a **‚ÄúRean√°lisis‚Äù**.
  - **Rechazar apelaci√≥n / cerrar:** si el admin determina que no procede, se deja **‚ÄúCerrado‚Äù**.
- **Regla de una sola apelaci√≥n:**
  - Solo se permite **un rean√°lisis** por PQRS.
  - Si ya existe rean√°lisis, cualquier intento adicional retorna **409**.
- **Registro de rean√°lisis:**
  - Solo se puede crear rean√°lisis si existe un an√°lisis previo y la PQRS est√° en estado **‚ÄúRean√°lisis‚Äù**.
  - El rean√°lisis requiere `answer` y `action_taken` (no vac√≠os).
- **Inmutabilidad al cierre:** cuando la PQRS est√° en **‚ÄúCerrado‚Äù**, no se permite crear ni editar an√°lisis/rean√°lisis (respuesta **409**).
- **Trazabilidad:** `analysis.responsible_id` y `reanalysis.responsible_id` quedan registrados; `created_at` se genera autom√°ticamente.
- **Eventos y notificaciones:** al crear an√°lisis/rean√°lisis y al cambiar el estado, se generan los eventos WebSocket y/o notificaciones in-app definidas en HU-03.
**Estimaci√≥n:**

- 4 puntos ‚Üí **2 d√≠as h√°biles**

**Tareas:**

- Endpoint an√°lisis ‚Üí 0,75 d√≠as
- Endpoint rean√°lisis ‚Üí 0,75 d√≠as
- Reglas de negocio ‚Üí 0,5 d√≠as

------

### üß© √âpica 3: Notificaciones y Tiempo Real

#### üü¢ HU-03

**Como usuario interno, quiero recibir notificaciones en tiempo real para conocer cambios en las PQRS.**

**Descripci√≥n:**
 Implementaci√≥n de notificaciones in-app y eventos WebSocket.

**Criterios de aceptaci√≥n:**

- **Generaci√≥n de notificaciones:** el sistema crea notificaciones in-app (tabla `notification`) en los eventos m√≠nimos:
  - Nueva PQRS radicada y asignada a un √°rea (para responsables del √°rea).
  - An√°lisis creado (para admin).
  - Apelaci√≥n habilitada (para responsables del √°rea).
  - Rean√°lisis creado (para admin).
  - PQRS cerrada (para responsables involucrados).
- **Estados de notificaci√≥n:** las notificaciones se crean con `status = NO_LEIDO` y se pueden marcar como `LEIDO`.
- **API de notificaciones:** existe un endpoint para:
  - Listar notificaciones del usuario autenticado (paginado).
  - Marcar una o varias como le√≠das.
  - Obtener contador de no le√≠das.
- **WebSockets autenticados:**
  - Solo usuarios autenticados pueden abrir un socket.
  - Cada usuario recibe **solo** eventos/notificaciones que le correspondan por rol/√°rea.
- **Eventos m√≠nimos en tiempo real:** se emiten eventos cuando:
  - Cambia `pqrs_status`.
  - Se crea `analysis`.
  - Se crea `reanalysis`.
  - Se crea `notification`.
  (Definir nombres y payload m√≠nimo: `event`, `pqrs_id`, `timestamp`, `status` y/o `notification_id`).
- **Consistencia UI:** si el usuario tiene abierta la lista/detalle de PQRS, los cambios se reflejan sin recargar la p√°gina.
- **Resiliencia:** ante reconexi√≥n, la UI puede recuperar el estado consultando API (y no depende exclusivamente del socket).
**Estimaci√≥n:**

- 2 puntos ‚Üí **1 d√≠a h√°bil**

**Tareas:**

- Configurar WebSockets ‚Üí 0,5 d√≠as
- Notificaciones in-app ‚Üí 0,5 d√≠as

------

### üß© √âpica 4: Integraci√≥n Chatbot WhatsApp

#### üü¢ HU-04

**Como cliente, quiero interactuar por WhatsApp para conocer el estado de mi PQRS y recibir notificaciones.**

**Descripci√≥n:**
 Integraci√≥n del bot n8n con backend y WhatsApp Cloud API.

**Criterios de aceptaci√≥n:**

- **Identificaci√≥n/creaci√≥n de cliente:**
  - El bot puede consultar si el cliente existe por `phone_number`/identificador WhatsApp.
  - Si no existe, lo crea con `type_person` (Natural/Jur√≠dica/An√≥nimo) y `stakeholder`.
  - Si el cliente se registra como **An√≥nimo**, `email` y `document` son opcionales.
- **Trazabilidad conversacional:** el bot registra la conversaci√≥n creando `chat` y `message` (tipo CLIENT/IA/ADMIN) asociados al cliente.
- **Auto-resoluci√≥n con base de conocimiento:**
  - Si el bot encuentra una respuesta en la base de conocimiento, responde al usuario y registra la interacci√≥n como **auto-resuelta**.
  - Si se decide registrar PQRS para m√©tricas, se crea con `is_auto_resolved = true` y `pqrs_status = Cerrado`.
- **Radicaci√≥n autom√°tica cuando no resuelve:**
  - Si no hay respuesta en base de conocimiento, el bot radica una PQRS con `is_auto_resolved = false`, `pqrs_status = Radicado` y un `ticket_number` √∫nico.
  - El bot informa al usuario el `ticket_number` y el compromiso de respuesta (15 d√≠as h√°biles).
- **Asignaci√≥n de √°rea:** la PQRS se asigna autom√°ticamente a un `area_id`/`area_code` seg√∫n palabras clave.
- **Consulta de estado:** el bot puede responder al comando/intenci√≥n ‚Äúestado‚Äù consultando el backend por `ticket_number` y devolviendo el estado actual.
- **Notificaciones WhatsApp:** el bot env√≠a mensajes autom√°ticos al cliente cuando:
  - Se inicia an√°lisis.
  - Se inicia rean√°lisis.
  - Se cierra la PQRS.
  - Se genera el link de encuesta.
- **Manejo de errores:** si el backend no responde o falla la creaci√≥n, el bot env√≠a un mensaje de contingencia y registra el evento para soporte.
**Estimaci√≥n:**

- 2 puntos ‚Üí **1 d√≠a h√°bil**

**Tareas:**

- Flujos n8n ‚Üí 0,5 d√≠as
- Integraci√≥n WhatsApp API ‚Üí 0,5 d√≠as

------

### üß© √âpica 5: Encuesta y Cierre

#### üü¢ HU-05

**Como cliente, quiero responder una encuesta al cierre de mi solicitud para evaluar el servicio.**

**Descripci√≥n:**
 Generaci√≥n de enlace p√∫blico y registro de encuesta.

**Criterios de aceptaci√≥n:**

- **Generaci√≥n de enlace p√∫blico:** al cerrar una PQRS, el sistema genera un **link p√∫blico** de encuesta asociado a esa PQRS (con token no adivinable).
- **Regla de cierre previo:** la encuesta **solo** se puede responder si la PQRS est√° en estado **‚ÄúCerrado‚Äù**; de lo contrario la API responde **403/409**.
- **Una respuesta por PQRS:** solo se permite **una encuesta** por `pqrs_id`; un segundo intento responde **409**.
- **Validaci√≥n de respuestas:**
  - `q1..q5` aceptan √∫nicamente valores **1 a 5**.
  - `comment` es opcional.
- **Persistencia:** al enviar el formulario, los datos se guardan en la tabla `survey` con `created_at`.
- **Disponibilidad del formulario:** el frontend expone un formulario accesible desde el link p√∫blico sin requerir login.
- **Notificaci√≥n al cliente:** el bot env√≠a el link de encuesta por WhatsApp inmediatamente despu√©s del cierre.
**Estimaci√≥n:**

- 1 punto ‚Üí **0,5 d√≠as h√°biles**

**Tareas:**

- Endpoint encuesta ‚Üí 0,25 d√≠as
- Formulario web ‚Üí 0,25 d√≠as

------

### üß© √âpica 6: Integraci√≥n Frontend + Deploy

#### üü¢ HU-06

**Como equipo, quiero integrar frontend, backend y bot y desplegar el sistema en producci√≥n.**

**Descripci√≥n:**
 Integraci√≥n final y despliegue productivo.

**Criterios de aceptaci√≥n:**

- **Integraci√≥n end-to-end (E2E) real:** se validan en ambiente productivo los siguientes casos m√≠nimos:
  1) **Auto-resuelto:** el usuario pregunta algo cubierto por la base de conocimiento ‚Üí recibe respuesta inmediata ‚Üí queda trazabilidad registrada.
  2) **Radicaci√≥n + an√°lisis + cierre:** el usuario radica PQRS ‚Üí el √°rea registra an√°lisis ‚Üí admin cierra ‚Üí el usuario recibe notificaci√≥n de cierre y encuesta.
  3) **Apelaci√≥n √∫nica:** tras la respuesta, se habilita apelaci√≥n ‚Üí el √°rea registra rean√°lisis ‚Üí admin cierra definitivamente ‚Üí encuesta.
  4) **An√≥nimo:** el usuario se registra como an√≥nimo ‚Üí se procesa sin exigir `email/document`.
- **Frontend integrado:**
  - Login funcional.
  - Lista PQRS + filtros b√°sicos.
  - Detalle PQRS con creaci√≥n de an√°lisis/rean√°lisis seg√∫n rol.
  - Panel admin para cierre / habilitar apelaci√≥n.
  - Centro de notificaciones in-app en tiempo real.
- **Observabilidad m√≠nima:** logs b√°sicos de backend y n8n para trazabilidad de errores (sin exponer datos sensibles).
- **Despliegue productivo:**
  - Backend y frontend accesibles v√≠a URL productiva.
  - Variables de entorno configuradas.
  - Conexi√≥n a BD verificada.
  - WebSockets operativos.
- **Checklist de entrega:** se documentan endpoints, variables de entorno y pasos de despliegue/rollback.
**Estimaci√≥n:**

- 1 punto ‚Üí **0,5 d√≠as h√°biles**

**Tareas:**

- Integraci√≥n frontend ‚Üí 0,25 d√≠as
- Deploy backend y frontend ‚Üí 0,25 d√≠as

------

## 5Ô∏è‚É£ Lista final de vistas

```
Aplicaci√≥n Web
‚îú‚îÄ‚îÄ Login
‚îú‚îÄ‚îÄ Dashboard
‚îÇ ‚îú‚îÄ‚îÄ Lista PQRS
‚îÇ ‚îî‚îÄ‚îÄ Notificaciones
‚îú‚îÄ‚îÄ PQRS
‚îÇ ‚îú‚îÄ‚îÄ Detalle PQRS
‚îÇ ‚îÇ ‚îú‚îÄ‚îÄ An√°lisis
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ Rean√°lisis
‚îú‚îÄ‚îÄ Administraci√≥n
‚îÇ ‚îú‚îÄ‚îÄ Decisi√≥n de apelaciones
‚îÇ ‚îî‚îÄ‚îÄ Cierre de PQRS
‚îî‚îÄ‚îÄ Encuesta
```

------

## 6Ô∏è‚É£ Planificaci√≥n del Sprint

### Sprint 1

- **Duraci√≥n:** 8 d√≠as h√°biles
- **Inicio:** Ma√±ana
- **Cierre:** Mi√©rcoles 28 de enero de 2026
- **Capacidad:** 16 puntos
- **Puntos planificados:** 16 puntos

**Objetivo del Sprint:**

> Entregar un sistema PQRS completamente funcional, integrado con WhatsApp, con gesti√≥n web, notificaciones y encuesta, desplegado en producci√≥n.

**Historias incluidas:**

- HU-01
- HU-02
- HU-03
- HU-04
- HU-05
- HU-06

------

## 7Ô∏è‚É£ Fecha objetivo del proyecto

- **Duraci√≥n total:** 8 d√≠as h√°biles
- **N√∫mero de sprints:** 1
- **Fecha de entrega final:** **Mi√©rcoles 28 de enero de 2026**